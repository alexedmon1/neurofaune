# Neurofaune Default Configuration
# This file contains default parameters for rodent MRI preprocessing
# Study-specific configurations should override these values

# Study information
study:
  name: "Rodent MRI Study"
  code: "STUDY001"
  species: "rat"  # or "mouse"
  strain: ""      # e.g., "Sprague-Dawley", "Wistar", "C57BL/6"

# Directory structure (neurovrai-compatible)
paths:
  study_root: "/mnt/arborea/bpa-rat"
  raw: "${paths.study_root}/raw"
  bruker: "${paths.raw}/bruker"
  bids: "${paths.raw}/bids"
  derivatives: "${paths.study_root}/derivatives"
  transforms: "${paths.study_root}/transforms"
  qc: "${paths.study_root}/qc"
  work: "${paths.study_root}/work"

# Atlas configuration
atlas:
  name: "SIGMA"
  base_path: "/mnt/arborea/atlases/SIGMA_scaled"  # Scaled 10x for FSL/ANTs compatibility

  # Study-space atlas (reoriented to match study acquisition orientation)
  # Set up using: setup_study_atlas() from neurofaune.templates.slice_registration
  # This is REQUIRED for registration - reorients SIGMA once rather than every image
  study_space:
    base_path: "${paths.study_root}/atlas/SIGMA_study_space"
    template: "${atlas.study_space.base_path}/SIGMA_InVivo_Brain_Template.nii.gz"
    template_masked: "${atlas.study_space.base_path}/SIGMA_InVivo_Brain_Template_Masked.nii.gz"
    brain_mask: "${atlas.study_space.base_path}/SIGMA_InVivo_Brain_Mask.nii.gz"
    gm_prob: "${atlas.study_space.base_path}/SIGMA_InVivo_GM.nii.gz"
    wm_prob: "${atlas.study_space.base_path}/SIGMA_InVivo_WM.nii.gz"
    csf_prob: "${atlas.study_space.base_path}/SIGMA_InVivo_CSF.nii.gz"
    parcellation: "${atlas.study_space.base_path}/SIGMA_InVivo_Anatomical_Brain_Atlas.nii.gz"

  # Modality-specific slice extraction
  slice_definitions:
    # DTI: Hippocampal region only (11 slices)
    dwi:
      start: 15
      end: 25
      description: "Hippocampus-centered for DTI analysis"

    # fMRI: Broader cortical coverage
    func:
      start: 10
      end: 35
      description: "Cortical and subcortical regions"

    # Anatomical: Full atlas
    anat:
      start: 0
      end: -1  # -1 means all slices
      description: "Complete brain atlas"

    # MSME: Custom range
    msme:
      start: 12
      end: 30
      description: "Region-specific T2 mapping"

    # MTR: Same as anatomical
    mtr:
      start: 0
      end: -1
      description: "Whole-brain MTR"

# Age cohort definitions (for developmental studies)
cohorts:
  p30:
    age_days: 30
    description: "Postnatal day 30 (juvenile)"
  p60:
    age_days: 60
    description: "Postnatal day 60 (young adult)"
  p90:
    age_days: 90
    description: "Postnatal day 90 (adult)"

# Execution settings
execution:
  plugin: "MultiProc"
  n_procs: 6
  stop_on_first_crash: false
  crashdump_dir: "${paths.work}/crash"

# ANTs configuration (rodent-optimized parameters)
ants:
  num_threads: 4
  dimension: 3

  # N4 bias correction
  n4:
    bspline_fitting_distance: 50  # Smaller for rodent brains
    shrink_factor: 2
    convergence_threshold: 0.0001
    n_iterations: [50, 50, 50, 50]

  # Registration parameters
  registration:
    # Rodent brains are smaller, need adjusted parameters
    initial_moving_transform: "Rigid"
    metric: "MI"  # Mutual Information
    metric_weight: 1.0
    radius_or_number_of_bins: 32
    sampling_strategy: "Regular"
    sampling_percentage: 0.25
    convergence_threshold: 1e-6
    convergence_window_size: 10
    shrink_factors: [8, 4, 2, 1]
    smoothing_sigmas: [3, 2, 1, 0]
    transforms: ["Rigid", "Affine", "SyN"]
    transform_parameters:
      Rigid: [0.1]
      Affine: [0.1]
      SyN: [0.1, 3, 0]  # [gradient_step, update_field_sigma, total_field_sigma]

  # Atropos segmentation
  atropos:
    n_classes: 3  # CSF, GM, WM
    prior_probability: 0.0
    iterations: 5
    mrf_smoothing_factor: 0.1
    mrf_radius: [1, 1, 1]

# Anatomical preprocessing (T2w for rodents)
anatomical:
  # Primary modality (T2w is standard for rodents)
  primary_contrast: "T2w"

  # Skull stripping method and parameters
  skull_strip:
    method: "atropos_bet"          # 'atropos_bet' (two-pass), 'atropos', 'bet', or 'auto'
    n_classes: 5                   # Atropos tissue classes (background, CSF, GM, WM, skull)
    atropos_iterations: 5          # Atropos convergence iterations
    atropos_convergence: 0.0       # Atropos convergence threshold
    mrf_smoothing_factor: 0.1      # Markov Random Field smoothing
    mrf_radius: [1, 1, 1]          # MRF neighborhood radius
    tissue_confidence_threshold: 0.35  # Min probability for tissue assignment in segmentation
    morphological_closing_iterations: 2  # Closing iterations for mask cleanup
    foreground_otsu_multiplier: 0.3     # Otsu threshold multiplier for foreground mask
    # Adaptive BET parameters (used in atropos_bet two-pass method)
    adaptive_bet:
      cnr_thresholds: [1.5, 3.0]       # CNR boundaries for frac selection
      frac_mapping: [0.20, 0.28, 0.38] # Frac values for [low, medium, high] CNR

  # Legacy BET parameters (used when skull_strip.method = 'bet')
  bet:
    frac: 0.3  # Lower threshold for rodent brains
    vertical_gradient: 0.0  # Rodent brains have less vertical bias
    robust: true
    reduce_bias: true
    remove_eyes: false  # Less relevant for rodents

  # N4 bias field correction parameters
  n4:
    iterations: [50, 50, 30, 20]   # Iterations per resolution level
    shrink_factor: 3               # Downsampling factor for speed
    convergence_threshold: 1.0e-6  # Convergence threshold

  # Intensity normalization
  intensity_normalization:
    factor: 1000.0                 # Multiply brain-extracted image by this factor

  # Registration to atlas/template (cohort-age-adaptive params)
  registration:
    method: "ants"
    output_warped_image: true
    output_inverse_warped_image: true
    smoothing_sigmas: [[3, 2, 1, 0], [2, 1, 0]]
    shrink_factors: [[8, 4, 2, 1], [4, 2, 1]]
    iterations: [[1000, 500, 250, 100], [100, 70, 50, 20]]
    convergence_threshold: 1.0e-6
    convergence_window_size: 10
    syn_params: [0.1, 3.0, 0.0]   # [gradient_step, update_field_sigma, total_field_sigma]
    metric_bins: 32                # Number of histogram bins for MI metric

  # QC settings
  run_qc: true

# Diffusion preprocessing
diffusion:
  # Denoising
  denoise_method: "dwidenoise"  # MP-PCA denoising

  # Intensity normalization (RECOMMENDED - enabled by default)
  # Different Bruker ParaVision reconstruction settings can result in vastly
  # different intensity scales (e.g., 0-50 vs 0-300000) due to different
  # VisuCoreDataSlope values. This causes BET to fail on low-intensity data.
  # Normalization ensures consistent intensity ranges for reliable brain extraction.
  intensity_normalization:
    enabled: true  # Set to false to disable (not recommended)
    target_max: 10000.0  # Target maximum intensity after normalization

  # Skull stripping for DWI b0
  skull_strip:
    method: "atropos_bet"          # 'atropos_bet', 'atropos', 'bet', or 'auto'
    n_classes: 3                   # 3-class: brightest class = brain (proven for DWI b0)

  # Brain extraction method for DWI (legacy key, use skull_strip instead)
  brain_extraction:
    method: atropos  # 'atropos' or 'bet'

  # BET parameters (used when brain_extraction.method = 'bet')
  bet:
    frac: 0.25  # More conservative for DWI
    robust: true

  # TOPUP distortion correction (if reverse PE images available)
  topup:
    readout_time: 0.05  # Study-specific, check protocol
    pe_direction: "AP"  # or "PA", "LR", "RL"
    config: "b02b0.cnf"  # FSL config file

  # Eddy current and motion correction
  eddy:
    use_cuda: true  # GPU acceleration (10-50x faster)
    flm: "linear"
    slm: "linear"
    fwhm: 0
    niter: 5
    s2v_lambda: 1
    s2v_niter: 5
    repol: true                        # Outlier replacement
    phase_encoding_direction: "0 -1 0" # Acquisition PE direction for acqparams.txt
    readout_time: 0.05                 # Total readout time (seconds)
    data_is_shelled: true              # Skip shell auto-detection (Bruker multi-shell data)
    slice_padding: 2                   # Pad N slices on each side before eddy

  # DTI fitting
  dti:
    fit_method: "WLS"  # Weighted least squares
    min_bval: 5  # Treat as b0 if below this

  # Advanced models
  advanced:
    # DKI (requires multi-shell)
    dki:
      enabled: false
      min_shells: 2

    # NODDI (requires multi-shell)
    noddi:
      enabled: false
      use_amico: true  # 100x faster than DIPY
      min_shells: 2

  # BEDPOSTX (for tractography)
  bedpostx:
    enabled: false
    use_gpu: true
    n_fibres: 2
    model: 2  # Ball-and-sticks model

  # Spatial normalization to atlas
  normalization:
    enabled: true
    target_space: "SIGMA"
    reference_image: "FA"  # Use FA for registration

  # QC settings
  run_qc: true

# Functional preprocessing
functional:
  # Acquisition parameters
  tr: 1.0  # Repetition time (seconds) - study-specific
  te: 30.0  # Echo time (ms) - study-specific, or list for multi-echo

  # Slice timing correction (run BEFORE motion correction)
  # Corrects for temporal differences in slice acquisition within each TR
  slice_timing:
    enabled: false  # DISABLED - was causing zebra stripe artifacts
    order: custom  # 'sequential_ascending', 'sequential_descending', 'interleaved', 'interleaved_even_first', 'custom'
    custom_order: [0, 2, 4, 6, 8, 1, 3, 5, 7]  # Bruker interleaved odd-first for 9 slices
    reference_slice: middle  # Slice to align to (middle = middle in time, or integer)

  # Optimized adaptive skull stripping (PRODUCTION)
  # Strategy: N4 bias correction + intensity normalization + adaptive per-slice BET with -R flag
  # Achieves 0.8% protocol generalization across 2-4mm voxel sizes (tested on 6 protocols, 203 scans)
  skull_strip_adaptive:
    target_ratio: 0.15           # Target 15% extraction per slice
    frac_range: [0.30, 0.90]     # Wide range accommodates all protocols (2× voxel size requires 2× frac)
    frac_step: 0.05              # Test 13 frac values per slice (0.30, 0.35, ..., 0.90)
    use_R_flag: true             # BET robust center estimation (0.8% vs 0.9% with explicit COG)
    invert_intensity: false      # Standard T2w contrast (inversion worsens to 2.7% difference)

  # Legacy BET parameters (kept for reference, not used with preprocessing approach)
  bet:
    frac: 0.3
    functional: true  # Optimized for BOLD

  # Motion correction
  motion_correction:
    method: "mcflirt"  # or "ants"
    reference: "middle"  # Use middle volume as reference

  # Spatial smoothing
  smoothing:
    fwhm: 6  # mm (matching old pipeline to eliminate zebra stripes)

  # Temporal filtering
  filtering:
    highpass: 0.01  # Hz
    lowpass: 0.1    # Hz

  # Denoising strategy
  denoising:
    # Rodent-specific ICA denoising (replaces ICA-AROMA)
    ica:
      enabled: true
      n_components: null  # Let MELODIC automatically determine optimal dimensionality (recommended)
      classification_mode: "score"  # 'score' (recommended) or 'threshold'
      motion_threshold: 0.40  # Motion correlation threshold
      edge_threshold: 0.80  # Edge fraction threshold
      csf_threshold: 0.70  # CSF overlap threshold
      freq_threshold: 0.60  # High-frequency power threshold

    # ACompCor (anatomical nuisance regression)
    # Extracts principal components from CSF/WM to remove physiological noise
    # Can be used as alternative to ICA or complementary with it
    acompcor:
      enabled: true  # Enable to extract physiological noise components
      num_components: 5  # Number of components from each tissue (CSF, WM)
      variance_threshold: 0.5  # Minimum tissue probability threshold

    # GLM confound regression - motion regressors always computed
    glm:
      enabled: false  # Set to true if not using ICA

  # Motion QC thresholds
  motion_qc:
    fd_threshold: 0.5               # Framewise displacement threshold (mm)

  # Registration (DISABLED - under development)
  # Registration to anatomical and atlas spaces will be added in future releases
  registration:
    enabled: false  # Disable for now
    method: "ants"
    cost_function: "corratio"  # Correlation ratio (faster than BBR)
    dof: 6  # Rigid registration to anatomical

  # Spatial normalization (DISABLED - under development)
  normalization:
    enabled: false  # Disable for now
    target_space: "SIGMA"
    reuse_transforms: true  # Reuse anatomical transforms

  # QC settings
  run_qc: true

# Spectroscopy (FSL-MRS)
spectroscopy:
  # Basis set
  basis_set: "7T_rat"  # Study-specific

  # Preprocessing
  preprocess:
    frequency_correction: true
    phase_correction: true
    eddy_correction: true
    water_suppression: true

  # Quantification
  quantification:
    method: "Newton"  # or "MH" (Metropolis-Hastings)
    baseline_order: 2
    metab_groups: []  # Metabolite groups for fitting

  # QC settings
  run_qc: true

# MSME (Multi-Slice Multi-Echo) T2 mapping
msme:
  # Skull stripping for MSME data
  skull_strip:
    method: "atropos_bet"          # 'atropos_bet' (recommended for 5-slice MSME)
    n_classes: 3                   # Fewer classes for partial-coverage data
    # Adaptive slice-wise parameters (used when method='adaptive')
    target_ratio: 0.15             # Target 15% extraction per slice
    frac_min: 0.3                  # Minimum frac to test
    frac_max: 0.8                  # Maximum frac to test
    frac_step: 0.05                # Test frac values in steps
    # COG estimation: offset from image center (in voxels)
    cog_offset_x: 0               # X offset from image center (positive = right)
    cog_offset_y: -40             # Y offset from image center (negative = down/inferior)

  # T2 fitting (legacy mono-exponential)
  fitting:
    method: "nonlinear"  # or "linear" (log-linear)
    bounds: [10, 500]  # T2 value bounds (ms)

  # NNLS-based T2 fitting and MWF calculation
  t2_fitting:
    n_components: 120              # Number of T2 components in NNLS spectrum
    t2_range: [10, 2000]           # T2 distribution range (ms) [min, max]
    lambda_reg: 0.5                # Tikhonov regularization parameter
    myelin_water_cutoff: 25        # T2 cutoff for myelin water (ms)
    intra_extra_cutoff: 40         # T2 cutoff for intra/extra-cellular water (ms)

  # Registration
  registration:
    method: "ants"
    target_space: "SIGMA"

  # QC settings
  run_qc: true

# MTR (Magnetization Transfer Ratio)
mtr:
  # MTR calculation
  calculation:
    # MTR = (M0 - Msat) / M0 * 100
    threshold: 0.0  # Minimum signal threshold

  # Registration
  registration:
    method: "ants"
    target_space: "SIGMA"

  # QC settings
  run_qc: true

# Quality control settings
qc:
  # Output format
  format: "html"  # HTML reports with interactive plots

  # Figure settings
  figures:
    dpi: 150
    format: "png"
    colormap: "viridis"

  # Thresholds for automatic flagging
  thresholds:
    # Motion (mm)
    max_framewise_displacement: 0.5
    max_mean_displacement: 0.3

    # Registration quality
    min_registration_correlation: 0.7

    # Signal quality
    min_tsnr: 50

    # DTI metrics (reasonable ranges for rodents)
    fa_range: [0, 1]
    md_range: [0, 0.003]  # mm²/s
