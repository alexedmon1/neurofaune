# BPA-Rat Study Configuration
# Example configuration for the BPA-Rat developmental study

# Study information
study:
  name: "BPA-Rat Developmental MRI Study"
  code: "BPA-RAT"
  species: "rat"
  strain: "Sprague-Dawley"
  description: "Multi-modal MRI study of BPA exposure effects across development"

# Directory structure (neurovrai-compatible)
paths:
  study_root: "/mnt/arborea/bpa-rat"
  raw: "${paths.study_root}/raw"
  bruker: "${paths.study_root}/raw/bruker"  # Archived original Bruker data
  bids: "${paths.study_root}/raw/bids"       # Converted BIDS data
  derivatives: "${paths.study_root}/derivatives"
  templates: "${paths.study_root}/templates"  # Age-specific templates
  transforms: "${paths.study_root}/transforms"  # Subject transforms
  qc: "${paths.study_root}/qc"
  work: "${paths.study_root}/work"

# Atlas configuration
atlas:
  name: "SIGMA"
  base_path: "/mnt/arborea/atlases/SIGMA_scaled"  # Original SIGMA atlas (10x scaled)
  version: "v1.0"

  # Study-space atlas (reoriented to match study acquisition orientation)
  # Generated by: setup_study_atlas() from neurofaune.templates.slice_registration
  # This avoids having to reorient every image to atlas space
  study_space:
    base_path: "${paths.study_root}/atlas/SIGMA_study_space"
    template: "${atlas.study_space.base_path}/SIGMA_InVivo_Brain_Template.nii.gz"
    template_masked: "${atlas.study_space.base_path}/SIGMA_InVivo_Brain_Template_Masked.nii.gz"
    brain_mask: "${atlas.study_space.base_path}/SIGMA_InVivo_Brain_Mask.nii.gz"
    gm_prob: "${atlas.study_space.base_path}/SIGMA_InVivo_GM.nii.gz"
    wm_prob: "${atlas.study_space.base_path}/SIGMA_InVivo_WM.nii.gz"
    csf_prob: "${atlas.study_space.base_path}/SIGMA_InVivo_CSF.nii.gz"
    parcellation: "${atlas.study_space.base_path}/SIGMA_InVivo_Anatomical_Brain_Atlas.nii.gz"

  # Slice definitions for different modalities
  # (relative to coronal orientation)
  slice_definitions:
    # DTI: 11 slices covering hippocampus â†’ frontal cortex
    dwi:
      start: 15
      end: 26  # Inclusive: slices 15-25 (11 total)
      description: "Hippocampal to frontal cortex coverage"

    # fMRI: Broader coverage for functional connectivity
    func:
      start: 10
      end: 36  # 26 slices
      description: "Broader cortical and subcortical coverage"

    # Anatomical: Full brain
    anat:
      start: 0
      end: -1  # All slices
      description: "Whole brain"

# Age cohorts (developmental timepoints)
cohorts:
  p30:
    age_days: 30
    description: "Early adolescence"
    n_subjects: 54

  p60:
    age_days: 60
    description: "Late adolescence"
    n_subjects: 50

  p90:
    age_days: 90
    description: "Early adulthood"
    n_subjects: 79

# Template building configuration
templates:
  # Subject selection for template building
  selection:
    method: "qc_based"  # or "random"
    top_percent: 0.333  # Use top 1/3 of subjects
    min_subjects: 10    # Minimum required per cohort

  # ANTs template construction parameters
  construction:
    n_iterations: 4
    gradient_step: 0.2
    dimension: 3
    use_float: true

  # Automatic SIGMA registration (T2w only)
  sigma_registration:
    enabled: true
    transform_type: "SyN"

# Execution settings
execution:
  plugin: "MultiProc"
  n_procs: 8
  stop_on_first_crash: false
  keep_unnecessary_outputs: false

# Memory and resource limits
resources:
  # Per-process memory limits (GB)
  memory_gb: 16

  # GPU settings
  gpu:
    enabled: true
    device: 0  # CUDA device ID

# Anatomical preprocessing parameters
anatomical:
  # Skull stripping
  skull_strip:
    method: "atropos_bet"          # 'atropos_bet' (two-pass), 'atropos', 'bet', or 'auto'
    n_classes: 5                   # Atropos tissue classes
    atropos_iterations: 5          # Atropos convergence iterations
    atropos_convergence: 0.0       # Atropos convergence threshold
    mrf_smoothing_factor: 0.1      # MRF smoothing
    mrf_radius: [1, 1, 1]          # MRF neighborhood radius
    tissue_confidence_threshold: 0.35  # Min probability for tissue assignment
    morphological_closing_iterations: 2
    foreground_otsu_multiplier: 0.3
    adaptive_bet:
      cnr_thresholds: [1.5, 3.0]
      frac_mapping: [0.20, 0.28, 0.38]

  # N4 bias field correction
  n4:
    iterations: [50, 50, 30, 20]
    shrink_factor: 3
    convergence_threshold: 1.0e-6

  # Intensity normalization
  intensity_normalization:
    factor: 1000.0

  # Registration to template
  registration:
    enabled: true
    method: "ants"
    smoothing_sigmas: [[3, 2, 1, 0], [2, 1, 0]]
    shrink_factors: [[8, 4, 2, 1], [4, 2, 1]]
    iterations: [[1000, 500, 250, 100], [100, 70, 50, 20]]
    convergence_threshold: 1.0e-6
    convergence_window_size: 10
    syn_params: [0.1, 3.0, 0.0]
    metric_bins: 32

# Diffusion preprocessing parameters
diffusion:
  # Skull stripping
  skull_strip:
    method: "atropos_bet"          # 'atropos_bet', 'atropos', 'bet', or 'auto'
    n_classes: 3                   # 3-class: brightest class = brain (for DWI b0)

  # Brain extraction (legacy)
  bet:
    frac: 0.3
    robust: true

  # Eddy correction
  eddy:
    use_cuda: true      # Use GPU acceleration
    cuda_device: 0
    repol: true         # Replace outliers
    phase_encoding_direction: "0 -1 0"  # PE direction for acqparams.txt
    readout_time: 0.05                  # Total readout time (seconds)
    data_is_shelled: true               # Skip shell auto-detection
    slice_padding: 2                    # Pad N slices before eddy

  # DTI fitting
  fitting:
    method: "dipy"      # Use dipy TensorModel
    fit_method: "WLS"   # Weighted least squares

  # Normalization to template
  normalization:
    target_space: "template"  # Register to age-matched FA template
    transform_type: "SyN"

# Functional preprocessing parameters
functional:
  # Motion correction
  motion_correction:
    ref_vol: "median"   # Use median volume as reference
    cost: "normcorr"    # Normalized correlation

  # Slice timing correction
  slice_timing:
    enabled: true
    ref_slice: "middle"

  # Spatial smoothing
  smoothing:
    fwhm: 0.5          # Smaller for rodent brains (mm)

  # Temporal filtering
  temporal_filter:
    highpass: 0.01     # Hz
    lowpass: 0.1       # Hz

  # ICA-AROMA denoising
  aroma:
    enabled: true
    denoise_type: "nonaggr"  # Non-aggressive

  # CompCor
  compcor:
    n_components: 6
    method: "aCompCor"  # Anatomical CompCor

  # Normalization
  normalization:
    target_space: "template"  # Register to age-matched BOLD template
    transform_type: "SyN"

# MSME (T2 relaxometry) parameters
msme:
  skull_strip:
    method: "atropos_bet"
    n_classes: 3                   # Fewer classes for partial-coverage data

  # NNLS-based T2 fitting and MWF calculation
  t2_fitting:
    n_components: 120              # T2 components in NNLS spectrum
    t2_range: [10, 2000]           # T2 distribution range (ms)
    lambda_reg: 0.5                # Tikhonov regularization
    myelin_water_cutoff: 25        # T2 cutoff for myelin water (ms)
    intra_extra_cutoff: 40         # T2 cutoff for intra/extra-cellular water (ms)

  # Registration
  registration:
    target_space: "T2w"  # Register to anatomical
    transform_type: "Affine"

# MTR (Magnetization Transfer Ratio) parameters
mtr:
  # MTR calculation
  calculation:
    formula: "100 * (MT_off - MT_on) / MT_off"

  # Registration
  registration:
    target_space: "T2w"  # Register to anatomical
    transform_type: "Affine"

# Quality control settings
qc:
  # Anatomical QC
  anat:
    skull_strip_overlay: true
    registration_overlay: true
    tissue_segmentation: true

  # DTI QC
  dwi:
    motion_plots: true
    eddy_qc: true
    fa_histogram: true
    registration_overlay: true

  # fMRI QC
  func:
    motion_plots: true
    carpet_plot: true
    confounds_correlation: true
    registration_overlay: true

# Logging
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  file: "${paths.study_root}/neurofaune.log"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
